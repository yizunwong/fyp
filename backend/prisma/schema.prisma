generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String?
  role      Role   @default(FARMER)
  email     String  @unique
  nric      String  @unique
  phone     String?
  farms     Farm[]   @relation("FarmerFarms")
  provider  String   @default("local")
  providerId String?
  subsidies Subsidy[]
  retailerDetails RetailerDetails?
  shipments Produce[] @relation("RetailerProduce")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  QRScan    QRScan[]
}

enum Role {
  FARMER
  RETAILER
  GOVERNMENT_AGENCY
  ADMIN
}

model RetailerDetails {
  id              String   @id @default(cuid())
  retailer        User     @relation(fields: [retailerId], references: [id])
  retailerId      String   @unique
  companyName     String
  businessAddress String
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model Farm {
  id          String   @id @default(cuid())
  farmer      User     @relation("FarmerFarms", fields: [farmerId], references: [id])
  farmerId    String
  name        String
  location    String
  size        Float
  sizeUnit    AreaUnit @default(HECTARE)
  documents   Json?    // store land titles, DOA certs, etc.
  produceCategories String[]
  produces    Produce[]
  createdAt   DateTime @default(now())
}

model Produce {
  id          String    @id @default(cuid())
  farm        Farm      @relation(fields: [farmId], references: [id])
  farmId      String
  retailer    User?     @relation("RetailerProduce", fields: [retailerId], references: [id])
  retailerId  String?
  imageUrl    String?  @db.VarChar(500)
  name        String
  category    String
  batchId     String    @unique
  certifications Json?  
  harvestDate DateTime
  blockchainTx String?  
  status      ProduceStatus @default(DRAFT)
  quantity    Float
  unit        ProduceUnit @default(KG)
  qrCode     QRCode?
  createdAt   DateTime  @default(now())

  @@index([status, harvestDate])
  @@index([retailerId, status])
}

model QRCode {
  id        String   @id @default(cuid())
  produce   Produce  @relation(fields: [produceId], references: [id])
  produceId String   @unique

  imageUrl  String
  verifyUrl String  
  qrHash    String?  

  isPublicQR Boolean @default(true) 
  createdAt  DateTime @default(now())
  
  scans      QRScan[]
}


model QRScan {
  id        String   @id @default(cuid())
  qrCode    QRCode   @relation(fields: [qrCodeId], references: [id])
  qrCodeId  String
  scannedBy User?    @relation(fields: [scannedById], references: [id])
  scannedById String?
  timestamp DateTime @default(now())
  location  String?
}

model Subsidy {
  id           String   @id @default(cuid())
  farmer       User     @relation(fields: [farmerId], references: [id])
  farmerId     String
  amount       Float
  status       SubsidyStatus @default(PENDING)
  triggeredBy  WeatherEvent? @relation(fields: [weatherEventId], references: [id])
  weatherEventId String?
  createdAt    DateTime @default(now())
  approvedAt   DateTime?
}

enum SubsidyStatus {
  PENDING
  APPROVED
  REJECTED
  DISBURSED
}

model WeatherEvent {
  id         String   @id @default(cuid())
  eventType  String   // flood, drought, heavy rain
  stationId  String
  rainfall   Float?
  waterLevel Float?
  triggeredAt DateTime @default(now())
  subsidies  Subsidy[]
}

enum AreaUnit {
  HECTARE
  ACRE
  SQUARE_METER
}

enum ProduceUnit {
  KG
  G
  TONNE
  PCS
  BUNCH
  TRAY
  L
  ML
}

enum ProduceStatus {
  DRAFT
  PENDING_CHAIN
  ONCHAIN_CONFIRMED
  IN_TRANSIT
  VERIFIED
  ARCHIVED
}
