generator client {
  provider = "prisma-client"
  output   = "../prisma/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String        @id @default(cuid())
  username    String        
  password    String?
  role        Role          @default(FARMER)
  email       String        @unique
  nric        String        @unique
  phone       String?
  provider    String        @default("local")
  providerId  String?
  status      UserStatus    @default(PENDING_VERIFICATION)
  emailVerifiedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  QRScan      QRScan[]
  farmer      Farmer?
  agency      Agency?
  retailer    Retailer?
  notifications Notification[]
  activityLogs ActivityLog[]
  reports     Report[]
  tokens      UserToken[]
}

enum Role {
  FARMER
  RETAILER
  GOVERNMENT_AGENCY
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model UserToken {
  id         String        @id @default(cuid())
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  tokenHash  String
  type       UserTokenType
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime      @default(now())

  @@index([userId, type])
  @@index([tokenHash, type])
  @@index([expiresAt])
}

enum UserTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model Farmer {
  id             String          @id
  user           User            @relation(fields: [id], references: [id])
  farms          Farm[]          @relation("FarmerFarms")
  subsidies      Subsidy[]
  farmerPrograms FarmerProgram[]
}

model Retailer {
  id              String       @id
  user            User         @relation(fields: [id], references: [id])
  companyName     String
  businessAddress String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  FarmReviews     FarmReview[]
  shipments       Produce[]    @relation("RetailerProduce")
}

model Farm {
  id                 String                 @id @default(cuid())
  farmer             Farmer                 @relation("FarmerFarms", fields: [farmerId], references: [id])
  farmerId           String
  name               String
  address            String                 @default("")
  state              String                 @default("")
  district           String                 @default("")
  size               Float
  sizeUnit           AreaUnit               @default(HECTARE)
  produceCategories  String[]
  produces           Produce[]
  farmDocuments      FarmDocument[]
  verificationStatus FarmVerificationStatus @default(PENDING)
  rating             Float                  @default(0)
  ratingCount        Int                    @default(0)
  reviews            FarmReview[]
  createdAt          DateTime               @default(now())
}

model Subsidy {
  id              String            @id @default(cuid())
  farmer          Farmer            @relation(fields: [farmerId], references: [id])
  farmerId        String
  amount          Float
  status          SubsidyStatus     @default(PENDING)
  programs        Program?          @relation(fields: [programsId], references: [id])
  programsId      String?
  triggeredBy     WeatherEvent?     @relation(fields: [weatherEventId], references: [id])
  weatherEventId  String?
  metadataHash    String?           @db.VarChar(66) // keccak256 hash of off-chain claim payload
  onChainClaimId  Int?
  onChainTxHash   String?           @db.VarChar(66)
  rejectionReason String?
  evidences       SubsidyEvidence[]
  createdAt       DateTime          @default(now())
  approvedAt      DateTime?
  paidAt          DateTime?

  @@index([programsId])
  @@index([status])
}

model FarmerProgram {
  id         String   @id @default(cuid())
  farmer     Farmer   @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  farmerId   String
  programs   Program  @relation(fields: [programsId], references: [id], onDelete: Cascade)
  programsId String
  enrolledAt DateTime @default(now())

  @@unique([farmerId, programsId])
  @@index([programsId])
}

model FarmReview {
  id         String   @id @default(cuid())
  farm       Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  farmId     String
  produce    Produce  @relation(fields: [produceId], references: [id], onDelete: Cascade)
  produceId  String
  retailer   Retailer @relation(fields: [retailerId], references: [id])
  retailerId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([produceId, retailerId])
  @@index([farmId])
}

model Agency {
  id         String    @id @default(cuid())
  user       User      @relation(fields: [id], references: [id], onDelete: Cascade)
  agencyName String
  department String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  programs   Program[]
}

model Produce {
  id             String               @id @default(cuid())
  farm           Farm                 @relation(fields: [farmId], references: [id], onDelete: Cascade)
  farmId         String
  retailer       Retailer?            @relation("RetailerProduce", fields: [retailerId], references: [id])
  retailerId     String?
  imageUrl       String?              @db.VarChar(500)
  name           String
  category       String
  batchId        String               @unique
  certifications ProduceCertificate[]
  harvestDate    DateTime
  blockchainTx   String?
  status         ProduceStatus        @default(DRAFT)
  quantity       Float
  unit           ProduceUnit          @default(KG)
  qrCode         QRCode?
  createdAt      DateTime             @default(now())
  reviews        FarmReview[]

  @@index([status, harvestDate])
  @@index([retailerId, status])
}

model ProduceCertificate {
  id              String            @id @default(cuid())
  produce         Produce           @relation(fields: [produceId], references: [id], onDelete: Cascade)
  produceId       String
  type            CertificationType
  ipfsUrl         String
  verifiedOnChain Boolean           @default(false)
  issuedAt        DateTime?
  metadata        Json?
  fileName        String?
  mimeType        String?
  fileSize        Int?
  createdAt       DateTime          @default(now())

  @@index([produceId])
  @@index([type])
}

model QRCode {
  id        String  @id @default(cuid())
  produce   Produce @relation(fields: [produceId], references: [id], onDelete: Cascade)
  produceId String  @unique

  imageUrl  String
  verifyUrl String
  qrHash    String?

  isPublicQR Boolean  @default(true)
  createdAt  DateTime @default(now())

  scans QRScan[]
}

model QRScan {
  id          String   @id @default(cuid())
  qrCode      QRCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  qrCodeId    String
  scannedBy   User?    @relation(fields: [scannedById], references: [id])
  scannedById String?
  timestamp   DateTime @default(now())
  location    String?
}

enum SubsidyStatus {
  PENDING
  APPROVED
  REJECTED
  DISBURSED
}

model SubsidyEvidence {
  id         String              @id @default(cuid())
  subsidy    Subsidy             @relation(fields: [subsidyId], references: [id], onDelete: Cascade)
  subsidyId  String
  type       SubsidyEvidenceType
  storageUrl String
  fileName   String?
  mimeType   String?
  fileSize   Int?
  uploadedAt DateTime            @default(now())

  @@index([subsidyId])
}

enum SubsidyEvidenceType {
  PHOTO
  PDF
}

model WeatherEvent {
  id          String    @id @default(cuid())
  eventType   String
  stationId   String
  rainfall    Float?
  waterLevel  Float?
  triggeredAt DateTime  @default(now())
  subsidies   Subsidy[]
}

model Program {
  id              String              @id @default(cuid())
  onchainId       Int                 @unique
  name            String
  description     String?
  type            ProgramType         @default(MANUAL)
  startDate       DateTime
  endDate         DateTime
  status          ProgramStatus       @default(DRAFT) @map("status")
  eligibility     ProgramEligibility?
  payoutRule      PayoutRule?
  subsidies       Subsidy[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  farmerPrograms  FarmerProgram[]
  createdBy       String
  createdByAgency Agency              @relation(fields: [createdBy], references: [id])

  @@index([status, type])
  @@index([startDate, endDate])
}

model ProgramEligibility {
  id         String  @id @default(cuid())
  programs   Program @relation(fields: [programsId], references: [id], onDelete: Cascade)
  programsId String  @unique

  minFarmSize       Float?
  maxFarmSize       Float?
  states            String[]
  districts         String[]
  cropTypes         String[]
  landDocumentTypes LandDocumentType[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model PayoutRule {
  id         String   @id @default(cuid())
  programs   Program  @relation(fields: [programsId], references: [id], onDelete: Cascade)
  programsId String   @unique
  amount     Float
  maxCap     Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum ProgramType {
  DROUGHT   @map("drought")
  FLOOD     @map("flood")
  CROP_LOSS @map("crop_loss")
  MANUAL    @map("manual")
}

enum ProgramStatus {
  DRAFT    @map("draft")
  ACTIVE   @map("active")
}

enum AreaUnit {
  HECTARE
  ACRE
  SQUARE_METER
}

enum ProduceUnit {
  KG
  G
  TONNE
  PCS
  BUNCH
  TRAY
  L
  ML
}

enum ProduceStatus {
  DRAFT
  PENDING_CHAIN
  ONCHAIN_CONFIRMED
  IN_TRANSIT
  ARRIVED
  RETAILER_VERIFIED
  ARCHIVED
}

enum CertificationType {
  HALAL
  GMP
  HACCP
  ISO_22000
  ORGANIC
  PESTICIDE_FREE
}

model FarmDocument {
  id                String                      @id @default(cuid())
  farm              Farm                        @relation(fields: [farmId], references: [id], onDelete: Cascade)
  farmId            String
  type              LandDocumentType
  ipfsUrl           String
  metadata          Json?
  fileName          String?
  mimeType          String?
  fileSize          Int?
  verificationStatus LandDocumentVerificationStatus @default(PENDING)
  rejectionReason   String?
  verifiedAt        DateTime?
  verifiedBy        String?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt

  @@index([farmId])
  @@index([type])
  @@index([verificationStatus])
}

enum LandDocumentType {
  GERAN_TANAH // Land Title (Grant)
  PAJAK_GADAI // Lease / Pawn Title
  SURAT_TAWARAN_TANAH // Land Offer Letter
  SURAT_PENGESAHAN_PEMAJU // Developer Confirmation Letter
  SURAT_PENGESAHAN_PENGHULU // Village Head Confirmation Letter
  LEASE_AGREEMENT // Tenant-based farm operations
  LAND_PERMISSION // Government / State land usage permission
  LAND_TAX_RECEIPT // Cukai Tanah
  SURAT_HAKMILIK_SEMENTARA // Temporary Ownership Document (Borang 5A)
  OTHERS // Catch-all fallback
}

enum FarmVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum LandDocumentVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Notification {
  id          String           @id @default(cuid())
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  title       String
  message     String
  type        NotificationType
  read        Boolean          @default(false)
  readAt      DateTime?
  relatedEntityType String?    // e.g., "Farm", "Subsidy", "Program"
  relatedEntityId   String?    // ID of the related entity
  metadata    Json?            // Additional data for the notification
  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  FARM_VERIFIED
  FARM_REJECTED
  SUBSIDY_APPROVED
  SUBSIDY_REJECTED
  SUBSIDY_DISBURSED
  PROGRAM_ENROLLED
  DOCUMENT_VERIFIED
  DOCUMENT_REJECTED
  SYSTEM
  GENERAL
}

model ActivityLog {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  action      String   // e.g., "CREATE_FARM", "UPDATE_PRODUCE", "VIEW_DASHBOARD"
  entityType  String?  // e.g., "Farm", "Produce", "Subsidy"
  entityId    String?  // ID of the affected entity
  details     Json?    // Additional details about the action
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action])
}

model Report {
  id          String     @id @default(cuid())
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  reportType  ReportType
  title       String
  parameters  Json?      // Filters, date ranges, and other options used to generate the report
  fileUrl     String?    // URL or path to the generated report file
  status      ReportStatus @default(GENERATING)
  errorMessage String?
  generatedAt DateTime?
  createdAt   DateTime   @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([reportType])
  @@index([status])
}

enum ReportType {
  FARM_SUMMARY
  SUBSIDY_REPORT
  PRODUCE_REPORT
  PROGRAM_REPORT
  FINANCIAL_REPORT
  ACTIVITY_REPORT
  CUSTOM
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}
